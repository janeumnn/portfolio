name: web-ci-cd
run-name: CI/CD - web (${{ github.event_name }} @ ${{ github.ref_name }})

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    paths:
      - 'apps/web/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  WRANGLER_VERSION: 4.51.0

jobs:
  checks:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Run check
        run: pnpm check

      - name: Run lint
        run: pnpm lint

  build:
    needs: checks
    runs-on: ubuntu-latest
    if: |
      github.ref_name == 'main' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'preview'))
    defaults:
      run:
        working-directory: apps/web
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Set environment
        uses: actions/github-script@v8
        env:
          DOTENV_PRIVATE_KEY_PREVIEW: ${{ secrets.DOTENV_PRIVATE_KEY_PREVIEW }}
          DOTENV_PRIVATE_KEY_PRODUCTION: ${{ secrets.DOTENV_PRIVATE_KEY_PRODUCTION }}
        with:
          script: |
            const {
              GITHUB_REF_NAME,
              DOTENV_PRIVATE_KEY_PREVIEW,
              DOTENV_PRIVATE_KEY_PRODUCTION,
            } = process.env

            if (GITHUB_REF_NAME === 'main') {
              core.exportVariable('DOTENV_PRIVATE_KEY_PRODUCTION', DOTENV_PRIVATE_KEY_PRODUCTION);
              core.exportVariable('DOTENV_ENV', 'production');
            } else {
              core.exportVariable('DOTENV_PRIVATE_KEY_PREVIEW', DOTENV_PRIVATE_KEY_PREVIEW);
              core.exportVariable('DOTENV_ENV', 'preview');
              core.exportVariable('SITE_URL', `https://portfolio-pr-${context.payload.pull_request?.number}.${{ vars.WORKER_DEV_URL }}`);
            }

      - name: Build
        run: pnpm build

      - name: Save build output
        uses: actions/cache/save@v4
        with:
          path: apps/web/dist
          key: web-build-${{ github.sha }}

  preview-deploy:
    needs: build
    if: github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'preview')
    runs-on: ubuntu-latest
    environment:
      name: preview
      url: ${{ steps.preview.outputs.url }}
    defaults:
      run:
        working-directory: apps/web
    env:
      WEB_WORKER_NAME: portfolio-pr-${{ github.event.pull_request.number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          sparse-checkout: |
            apps/web/wrangler.jsonc
            apps/web/.env.preview
          sparse-checkout-cone-mode: false

      - name: Restore build output
        uses: actions/cache/restore@v4
        with:
          path: apps/web/dist
          key: web-build-${{ github.sha }}
          restore-keys: |
            web-build-

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Deploy
        id: deploy
        uses: cloudflare/wrangler-action@v3.14.1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: ${{ env.WRANGLER_VERSION  }}
          workingDirectory: apps/web
          environment: preview
          preCommands: |
            npx @dotenvx/dotenvx set SITE_URL "$SITE_URL" -f .env.preview
            npx @dotenvx/dotenvx get -f .env.preview | jq 'del(.DOTENV_PUBLIC_KEY_PREVIEW)' | npx wrangler secret bulk --name $WEB_WORKER_NAME --env=""
          command: deploy --name ${{ env.WEB_WORKER_NAME }}
        env:
          DOTENV_PRIVATE_KEY_PREVIEW: ${{ secrets.DOTENV_PRIVATE_KEY_PREVIEW }}
          SITE_URL: https://portfolio-pr-${{ github.event.pull_request.number }}.${{ vars.WORKER_DEV_URL }}

      - name: Get preview URL
        id: preview
        uses: actions/github-script@v8
        with:
          script: |
            const previewUrl = 'https://${{ env.WEB_WORKER_NAME }}.${{ vars.WORKER_DEV_URL }}';
            core.setOutput('url', previewUrl);

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref_name == 'main'
    environment:
      name: production
      url: ${{ steps.deployment.outputs.url }}
    defaults:
      run:
        working-directory: apps/web
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          sparse-checkout: |
            apps/web/wrangler.jsonc
            apps/web/.env.production
          sparse-checkout-cone-mode: false

      - name: Restore build output
        uses: actions/cache/restore@v4
        with:
          path: apps/web/dist
          key: web-build-${{ github.sha }}
          restore-keys: |
            web-build-

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Deploy
        id: deploy
        uses: cloudflare/wrangler-action@v3.14.1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: ${{ env.WRANGLER_VERSION  }}
          workingDirectory: apps/web
          preCommands: |
            npx @dotenvx/dotenvx get -f .env.production | jq 'del(.DOTENV_PUBLIC_KEY_PRODUCTION)' | npx wrangler secret bulk --env=""
          command: deploy --domains ${{ vars.WEB_URL }} www.${{ vars.WEB_URL }} --env=""
        env:
          DOTENV_PRIVATE_KEY_PRODUCTION: ${{ secrets.DOTENV_PRIVATE_KEY_PRODUCTION }}

      - name: Get deployment URL
        id: deployment
        uses: actions/github-script@v8
        with:
          script: |
            core.setOutput('url', 'https://${{ vars.WEB_URL }}');
