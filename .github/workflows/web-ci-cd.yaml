name: web-ci-cd
run-name: CI/CD - web (${{ github.event_name }} @ ${{ github.ref_name }})

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    paths:
      - 'apps/web/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  WRANGLER_VERSION: 4.51.0

jobs:
  checks:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Run check
        run: pnpm check

      - name: Run lint
        run: pnpm lint

  build:
    needs: checks
    runs-on: ubuntu-latest
    if: |
      github.ref_name == 'main' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'preview'))
    defaults:
      run:
        working-directory: apps/web
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Set environment
        uses: actions/github-script@v8
        env:
          DOTENV_PRIVATE_KEY_PREVIEW: ${{ secrets.DOTENV_PRIVATE_KEY_PREVIEW }}
          DOTENV_PRIVATE_KEY_PRODUCTION: ${{ secrets.DOTENV_PRIVATE_KEY_PRODUCTION }}
        with:
          script: |
            const {
              GITHUB_REF_NAME,
              DOTENV_PRIVATE_KEY_PREVIEW,
              DOTENV_PRIVATE_KEY_PRODUCTION,
            } = process.env

            if (GITHUB_REF_NAME === 'main') {
              core.exportVariable('DOTENV_PRIVATE_KEY_PRODUCTION', DOTENV_PRIVATE_KEY_PRODUCTION);
              core.exportVariable('DOTENV_ENV', 'production');
            } else {
              core.exportVariable('DOTENV_PRIVATE_KEY_PREVIEW', DOTENV_PRIVATE_KEY_PREVIEW);
              core.exportVariable('DOTENV_ENV', 'preview');
              core.exportVariable('SITE_URL', `https://portfolio-pr-${context.payload.pull_request?.number}.${{ vars.WORKER_DEV_URL }}`);
            }

      - name: Build
        run: pnpm build

      - name: Save build output
        uses: actions/cache/save@v4
        with:
          path: apps/web/dist
          key: web-build-${{ github.sha }}

  preview-deploy:
    needs: build
    if: github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'preview')
    runs-on: ubuntu-latest
    environment:
      name: preview
      url: ${{ steps.preview.outputs.url }}
    defaults:
      run:
        working-directory: apps/web
    env:
      WEB_WORKER_NAME: portfolio-pr-${{ github.event.pull_request.number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          sparse-checkout: |
            apps/web/wrangler.jsonc
            apps/web/.env.preview
          sparse-checkout-cone-mode: false

      - name: Restore build output
        uses: actions/cache/restore@v4
        with:
          path: apps/web/dist
          key: web-build-${{ github.sha }}
          restore-keys: |
            web-build-

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Prepare secrets
        env:
          DOTENV_PRIVATE_KEY_PREVIEW: ${{ secrets.DOTENV_PRIVATE_KEY_PREVIEW }}
        run: |
          SECRETS_JSON=$(npx @dotenvx/dotenvx get -f .env.preview | jq 'with_entries(select(.key | startswith("DOTENV_PUBLIC_KEY") | not))')

          echo "WORKER_SECRET_NAMES<<EOF" >> $GITHUB_ENV
          echo "$SECRETS_JSON" | jq -r 'keys[]' >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "$SECRETS_JSON" | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while read -r line; do
             val="${line#*=}"
             echo "::add-mask::$val"
             echo "$line" >> $GITHUB_ENV
          done

      - name: Deploy
        id: deploy
        uses: cloudflare/wrangler-action@v3.12.0
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: ${{ env.WRANGLER_VERSION  }}
          workingDirectory: apps/web
          command: deploy --name ${{ env.WEB_WORKER_NAME }} --env preview
          secrets: ${{ env.WORKER_SECRET_NAMES }}

      - name: Get preview URL
        id: preview
        uses: actions/github-script@v8
        with:
          script: |
            const previewUrl = 'https://${{ env.WEB_WORKER_NAME }}.${{ vars.WORKER_DEV_URL }}';
            core.setOutput('url', previewUrl);

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref_name == 'main'
    environment:
      name: production
      url: ${{ steps.deployment.outputs.url }}
    defaults:
      run:
        working-directory: apps/web
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          sparse-checkout: |
            apps/web/wrangler.jsonc
          sparse-checkout-cone-mode: false

      - name: Restore build output
        uses: actions/cache/restore@v4
        with:
          path: apps/web/dist
          key: web-build-${{ github.sha }}
          restore-keys: |
            web-build-

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Deploy
        id: deploy
        uses: cloudflare/wrangler-action@v3.12.0
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: ${{ env.WRANGLER_VERSION  }}
          workingDirectory: apps/web
          command: deploy --domains ${{ vars.WEB_URL }} www.${{ vars.WEB_URL }}

      - name: Get deployment URL
        id: deployment
        uses: actions/github-script@v8
        with:
          script: |
            core.setOutput('url', 'https://${{ vars.WEB_URL }}');
